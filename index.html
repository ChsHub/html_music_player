<!DOCTYPE html>
<html lang="en">
<!--TODO The html/css layout of the top part can be improved. At the moment the top part is just fixed height. I wish it would adjust the height to the elements inside. Also the buttons, player, file input and volume slider don't really align with each other.
    TODO Add a way to adjust the player size, when playing a video. Maybe something like a vertical slider.
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Player</title>
    <style type="text/css">
        html {
            font-size: 62.5%;
            /*Reference for rem, Browser standard=16px -> 62.5% = 10px = 1rem*/
        }

        body,
        div {
            margin: 0;
            padding: 0;
        }

        body {
            /* Disable scrollbars and ensure that the body fills the window */
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #filesToUpload {
            background-color: lightskyblue;
        }

        #header {
            overflow: auto;
            position: absolute;
            width: 100%;
            height: 50rem;
        }

        #main {
            overflow: auto;
            position: absolute;
            width: 100%;
            top: 25rem;
            bottom: 0;
            padding: 0;
            margin: 0 auto;
        }

        .track {
            background-color: white;
            font-size: 2rem;
        }

        .marked {
            background-color: lightskyblue;
            font-size: 2rem;
        }

        .debug {
            padding: 1rem;
            background-color: #fa87ce;
            font-size: 2rem;
        }

        #player {
            height: 4rem;
            width: 90%;
            alignment: center;
        }

        #volume_slider {
            width: 80%;
            cursor: pointer;
        }

        #volume_wrapper {
            width: 100%;
            padding-top: 0.1rem;
        }

        #volume_label {
            text-align: right;
            font-size: 2rem;
        }

        #controls {
            margin-top: 1rem;
            padding: 0;
        }

        button {
            font-size: 4rem;
            cursor: pointer;
            width: 20rem;
            height: 5rem;
            display: inline-block;
            text-align: center;
            line-height: 5rem;
        }

        .track_button {

        }

        #start_stop_button {

        }

        #option_button {
            width: 6rem;
            height: 5rem;
            /*padding-left: 0.6em;
            padding-right: 0.6em;width: 6.6em;
            width: 5rem;*/
        }

        div, input {
            padding: 1rem;
        }
    </style>
    <script type="text/javascript">
        // https://jsbin.com/moyiro/4/edit?html,css,output
        // debugging
        var debugging = true;

        function info(text) {
            if (debugging) {
                var messages = document.getElementById('messages');
                var node = document.createElement("LI");                 // Create a <li> node
                node.appendChild(document.createTextNode(text));
                messages.appendChild(node);
                node.className = 'debug';
            }//no else
        }

        // Todo use OOP
        // Todo fit to screen size
        var tracks = [];
        var stack = [];
        var stack_pointer = 0;
        var loop_tracklist = true;
        var play_random = false;

        function init() {
            tracks = [];
            stack = [];
            stack_pointer = 0;
            loop_tracklist = false;
        }

        /* +++ Stack +++*/

        //  get next track from stack
        //  or if at stack end: increment or random track
        function get_next() {
            stack_pointer++;
            if (stack_pointer >= stack.length) {

                var next_track = 0;
                if (play_random) {
                    var tracks_played_count = stack.length % tracks.length;

                    next_track = Math.floor(Math.random() * (tracks.length - tracks_played_count));
                    // iterate tracks
                    // generate list of tracks not on stack, exit when counter matches random index (next_track)
                    var not_stack_count = -1;
                    var track_count = -1;
                    var last_played = stack.slice(stack.length - tracks_played_count, stack.length);
                    while (not_stack_count < next_track) {
                        track_count++;
                        if (last_played.indexOf(track_count) <= -1) {
                            not_stack_count++;
                        }//no else
                    }
                    next_track = track_count;
                } else {
                    next_track = stack[stack_pointer - 1] + 1; // top stack track +1
                    next_track %= tracks.length; // start playlist from zero
                }
                info("PUSH NEW ELE " + next_track);
                stack.push(next_track);
            }//no else

            return stack[stack_pointer];
        }

        function set_next(id) {

            stack = stack.slice(0, stack_pointer + 1); //delete upcoming history
            stack.push(id);
            stack_pointer = stack.length - 1;
            return stack[stack_pointer];
        }

        function get_prev() {
            stack_pointer--;
            /*TODO random*/
            if (-1 >= stack_pointer) {
                // javascript modulo
                var new_ele = ((stack[0] - 1 % tracks.length) + tracks.length) % tracks.length;

                stack = [new_ele].concat(stack);
                stack_pointer = 0;
            }// no else
            return stack[stack_pointer];
        }

        /* +++ +++*/

        function create_text_div(text) {
            var node = document.createElement("div");
            node.appendChild(document.createTextNode(text));
            return node;
        }

        function save_new_track(file, fileList) {

            var node = create_text_div(file.name);
            node.className = "track";
            node.setAttribute("onClick", "play_id_track(" + tracks.length + ");");
            fileList.appendChild(node);
            tracks.push(file);
        }

        function change_volume(volume) {
            document.getElementById('player').volume = volume / 100;
            document.getElementById('volume_label').innerHTML = Math.round(volume);
            document.getElementById('volume_slider').value = volume;
        }

        function get_files() {

            var input_tracks = document.getElementById('filesToUpload');
            var fileList = document.getElementById('fileList');
            var player = document.getElementById('player');
            if (input_tracks.files.length < 1) {
                return;
            }

            init();
            // remove old elements
            while (fileList.hasChildNodes()) {
                fileList.removeChild(fileList.lastChild);
            }
            // add tracks if they can be played
            for (var track_file of input_tracks.files) {
                var file_type = track_file.type;

                if (player.canPlayType(file_type)) {
                    save_new_track(track_file, fileList);
                } else {
                    info("Can't play " + track_file.name);
                }
            }
            play_id_track(0);
            change_volume(10); // inital volume
        }

        function play_file(track_nr) {

            // Unmark current track
            for (marked of document.getElementsByClassName("marked")) {
                marked.className = "track";
            }
            // Mark next track, and adjust scroll bar
            var current_track = document.getElementsByClassName("track")[track_nr];
            current_track.className = "marked";
            current_track.scrollIntoView();

            // Stop previous track and play current track
            var file_url = window.URL.createObjectURL(tracks[track_nr]);
            stop();
            document.getElementById('player').src = file_url;
            //document.getElementById('player').height = "720"; TODO remove
            play();
        }

        function stop() {
            document.getElementById('player').pause();

            var button = document.getElementById('start_stop_button');
            button.setAttribute("onClick", "play();");
            button.innerHTML = "&#9655;";
        }

        function play() {
            document.getElementById('player').play();

            var button = document.getElementById('start_stop_button');
            button.setAttribute("onClick", "stop();");
            button.innerHTML = "&#10072; &#10072;";
        }

        function play_next_track() {
            play_file(get_next())
        }

        function play_prev_track() {
            play_file(get_prev())
        }

        function play_id_track(id) {
            play_file(set_next(id))
        }

        function set_random() {
            var button = document.getElementById('option_button');
            button.innerHTML = "&#10536";
            button.setAttribute("onClick", "set_sorted();");
            play_random = true;
        }

        function set_sorted() {

            var button = document.getElementById('option_button');
            button.innerHTML = "&#8649";
            button.setAttribute("onClick", "set_random();");
            play_random = false;
        }

    </script>
</head>
<body>
<div id="header">
    <div id="">


        <video height="720" width="720" id="player" onended="play_next_track()" controls
               onvolumechange="change_volume(this.volume*100)">No support for html5.
        </video>

        <input type="file" name="filesToUpload" id="filesToUpload" multiple="" onchange="get_files();"/>

        <div id="controls">
            <button onclick="play_prev_track()" type="button" class="track_button">&#10703;</button>
            <button id="start_stop_button" onclick="stop()" type="button">&#9655;</button>
            <button onclick="play_next_track()" type="button" class="track_button">&#10704;</button>
            <button onclick="set_random()" id="option_button">&#8649;</button>
        </div>


        <div>
            <svg height="40" width="40">
                <polygon points="10,20 20,20 30,10 30,40 20,30 10,30"
                         style="fill:white;stroke:black;stroke-width:1px">
                </polygon>
            </svg>
            <div id="volume_wrapper"><input type="range" name="firstname" id="volume_slider" value="1"
                                            onchange="change_volume(this.value)"></div>
            <label id="volume_label"></label>
            <p></p>
            <br>
        </div>

    </div>

</div>
<div id="main">

    <div id="fileList"></div>

    <ol id="messages"></ol>
    <div id="texttest"></div> <!--TODO REMOVE DEBUG MESSAGES-->
</div>
</body>
</html>
