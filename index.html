<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Player</title>
    <style type="text/css">
        body,
        div {
            margin: 0;
            padding: 0;
        }

        body {
            /* Disable scrollbars and ensure that the body fills the window */
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        #filesToUpload, #drop_menu {

            background-color: aquamarine;
        }
        #menu_opener:hover {

            cursor: hand;
        }
        #header {
            /* Provide scrollbars if needed and fix the header dimensions */
            overflow: auto;
            position: absolute;
            width: 100%;
            height:  500px;
        }

        #main {
            /* Provide scrollbars if needed, position below header, and derive height from top/bottom */
            overflow: auto;
            position: absolute;
            width: 100%;
            top: 500px;
            bottom: 0;
            padding: 1px;
        }
        .track {
            background-color: white;
        }

        #marked {
            background-color: lightskyblue;
        }

        #player {
            height: 20px;
            width: 90%;
            padding: 40px;
            alignment: center;
        }

        #messages {
            background-color: firebrick;
        }

        #volume_slider {
            width: 90%;
        }

        #controls {
            margin: 10px;
            padding: 1px;
            alignment: center;

        }

        button {
            width: 200px;
            height: 50px;
        }

        div, input {
            padding: 10px;
        }
    </style>


    <script type="text/javascript">
        function create_check_box()
        {
            var x = document.createElement("INPUT");
            x.setAttribute("type", "checkbox");
            x.onclick = "";
            return x;
        }

        function open_menu()
        {
            //document.getElementById('filesToUpload').style.opacity = "0.0";
            var drop_menu = document.getElementById('drop_menu');
            var drop_menu_container = document.getElementById('drop_menu_container');
            if(drop_menu) {
                drop_menu_container.removeChild(drop_menu);
            }else
            {
                drop_menu = create_text_div("");
                drop_menu.id = "drop_menu";
                drop_menu_container.appendChild(drop_menu);

                var check_box = create_check_box();
                drop_menu.appendChild(check_box);
            }
        }

        // Todo use OOP
        // Todo fit to screen size
        var tracks = [];
        var loop_tracklist = false;
        var stack = [];
        var stack_pointer = 0;

        function init(){
            tracks = [];
            loop_tracklist = false;
            stack = [];
            stack_pointer = 0;
        }

        function get_current() {
            return stack[stack_pointer];
        }
        function push_top() {
            var new_ele = stack[stack_pointer - 1] + 1;
            if (new_ele == tracks.length) {
                //start playlist from top
                new_ele = 0;
            }
            stack.push(new_ele);
        }

        function push_bottom() {

            var new_ele = stack[0] - 1;
            if (new_ele == -1) {
                new_ele = tracks.length - 1;
            }

            var bottom = [new_ele];

            stack = bottom.concat(stack);
            set_message(stack);
            stack_pointer = 0;
        }

        function set_next(id) {
            stack_pointer++;
            stack.push(id);
            return id;
        }

        function get_next() {
            stack_pointer++;

            if (stack.length == stack_pointer) {
                push_top();
            }
            return stack[stack_pointer];
        }

        function get_prev() {
            stack_pointer--;

            if (-1 == stack_pointer) {
                push_bottom();
            }
            return stack[stack_pointer];
        }


        function set_message(text) {
            var messages = document.getElementById('messages');
            var textnode = document.createTextNode(text + "\n");
            var node = document.createElement("LI");                 // Create a <li> node
            node.appendChild(textnode);
            messages.appendChild(node);
        }

        function create_text_div(text)
        {   var node = document.createElement("div");
            var textnode = document.createTextNode(text);
            node.appendChild(textnode);
            return node;
        }

        function get_playlist_files(file_paths, fileList)
        {

            for (var i = 0; i < file_paths.length; i++) {
                set_message(file_paths[i]);
                var file = File(file_paths[i]);
                set_message(file);
                var filename = file.name;
                var filetype = filename.split(".").pop();

                if (filetype == "mp3") {
                    set_message(filename);
                    //save_new_track(file, fileList);
                }
            }
        }

        function readPlaylist(playlist_file, fileList) {
            //Retrieve the first (and only!) File from the FileList object

            var playlistfile_url = URL.createObjectURL(playlist_file);
            set_message(Page.ResolveURL(playlist_file));
            //document.getElementById("texttest").innerHTML = .;
            if (playlist_file) {
                var r = new FileReader();
                r.onload = function(e) {
                    var contents = e.target.result;
                    //alert( "Got the playlist_file.n"
                    //        +"name: " + playlist_file.name + "n"
                    //        +"type: " + playlist_file.type + "n"
                    //        +"size: " + playlist_file.size + " bytesn"
                    //        + "starts with: " + contents.substr(1, contents.indexOf("n"))
                    //);
                    set_message(contents);
                    get_playlist_files(contents.split("\n"), fileList)
                };
                r.readAsText(playlist_file);
            } else {
                alert("Failed to load playlist_file");
            }

        }

        function save_new_track(file, fileList){

            var node = create_text_div(file.name);
            node.className = "track";
            //save track
            set_message("HERE");
            node.setAttribute("onClick", "play_id_track(" + tracks.length + ");");
            tracks.push(file);
            fileList.appendChild(node);

        }

        function get_files(){
            init();
            var input_tracks = document.getElementById('filesToUpload');
            var fileList = document.getElementById('fileList');

            //empty list for now...
            while (fileList.hasChildNodes()) {
                fileList.removeChild(fileList.lastChild);
            }

            //for every file...
            for (var i = 0; i < input_tracks.files.length; i++) {
                //add to list
                //text1 = 'File ' + (i + 1) + ':  ' + input_tracks.files[i].name;
                var filename = input_tracks.files[i].name;
                var filetype = filename.split(".").pop();

                if (filetype == "mp3") {

                    save_new_track(input_tracks.files[i], fileList);

                } else {
                    if (filetype == "m3u"){

                        readPlaylist((input_tracks.files[i]), fileList);
                    }
                }

                set_message("loaded");
            }

            stack = [tracks.length - 1];
            play_next_track();
            document.getElementById("player").volume = get_init_volume() / 100;

        }

        // function open_file() {
        //     var loc = window.location.pathname;
        //     var dir = loc.substring(0, loc.lastIndexOf('/'));
        //     document.getElementById('boldStuff').innerHTML = loc;
        // }

        function play_file(track)
        {

            mark_current_file_view(track);
            var file_url = window.URL.createObjectURL(tracks[track]);
            //file_url = window.URL.createObjectURL(new File("file:///D:/Musik/Collection/AMV - Courage to tell a lie.mp3"));


            var player = document.getElementById('player');
            //if(player.canPlayType(file_url))
            player.pause();
            player.src = file_url;
            player.play();
            //set_message(file_url+"/../Collection/AMV - Courage to tell a lie.mp3");


        }

        function stop() {
            var player = document.getElementById('player');

            player.pause();

            var button = document.getElementById('start_stop_button');
            button.setAttribute("onClick", "play();");
            button.innerHTML = "Play Video";
        }

        function play() {
            var player = document.getElementById('player');
            player.play();

            var button = document.getElementById('start_stop_button');
            button.setAttribute("onClick", "stop();");
            button.innerHTML = "Stop Video";

        }

        function get_init_volume() {
            return 10;
        }

        function mark_current_file_view(track) {
            var track_view = document.getElementsByClassName("track")[track];

            track_view.id = "marked";

        }

        function unmark_current_file_view() {
            var marked = document.getElementById("marked");

            if (marked != null) {
                marked.id = "unmarked";
            }
        }


        function on_ended() {
            play_next_track();
        }

        function next() {
            play_next_track();
        }

        function prev() {
            play_prev_track();
        }


        function play_next_track() {
            unmark_current_file_view();

            play_file(get_next())
        }

        function play_prev_track() {
            unmark_current_file_view();
            play_file(get_prev())
        }

        function play_id_track(id) {
            unmark_current_file_view();
            play_file(set_next(id))
        }


        function change_volume(volume) {

            document.getElementById('player').volume = volume;
            set_message(volume);
        }


        function change_volume_view() {
            var volume = document.getElementById('player').volume;
            document.getElementById('volume_label').innerHTML = volume;
            document.getElementById('volume_slider').value = volume * 100;
        }

        function onchange_volume_slider() {
            var volume = document.getElementById('volume_slider').value / 100;
            change_volume(volume);

            document.getElementById('volume_label').innerHTML = volume;
        }


    </script>
</head>

<body>

<div id="header">
<div id="">
    <div id="drop_menu_container">
    <a><div id="menu_opener" onclick="open_menu()">Open Menu</div></a>
    </div>
    <div>
        <video
                controls
                id="player" onended="on_ended()" onvolumechange="change_volume_view()">No support for html5.
        </video>
    </div>
    <div>
        <input type="file" name="filesToUpload" id="filesToUpload" multiple="" onchange="get_files();"/>

        <div id="controls">
            <button onclick="prev()" type="button">Prev Video</button>
            <button id="start_stop_button" onclick="stop()" type="button">Stop Video</button>
            <button onclick="next()" type="button">Next Video</button>
            <br>
        </div>
    </div>



    <label for="volume_slider">Volume</label>
    <input type="range" name="firstname" id="volume_slider" value="1" onchange="onchange_volume_slider()">
    <label id="volume_label"></label>
    <p></p>
    <br>
</div>

</div>
<div id="main">

<div id="fileList">
    <div class="track" id="marked">No Files Selected</div>
</div>

<ol id="messages"></ol>
<div id="texttest"></div>
</div>
<!--[if lt IE 7]>
<script type="text/javascript">
    var elMain = document.getElementById('main');

    setMainDims();
    document.body.onresize = setMainDims;

    function setMainDims() {
        elMain.style.height = (document.body.clientHeight - 200) + 'px';
        elMain.style.width = '99%'
        setTimeout("elMain.style.width = '100%'", 0);
    }
</script>
</body>
</html>